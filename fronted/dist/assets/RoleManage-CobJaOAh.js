import{_ as ce,r as f,af as Z,o as fe,a as pe,d as l,g as s,h as g,E as d,B as me,l as w,u as _,a2 as q,m as p,ap as ye,a8 as ve,b as T,A as ge,C as V,ar as he,aM as ke,N as _e,as as we,s as F,Z as G,t as D,z as J,aN as be,at as Ce}from"./index-DuLhCfRm.js";import{g as xe,a as Ve,b as Q,d as De,c as $e,u as Ie,s as W}from"./role-DBJ_vj2k.js";import{g as X}from"./permission-BSIMFRWT.js";const Me={class:"page-container"},ze={style:{display:"flex","align-items":"center",width:"100%"}},Re={style:{flex:"1"}},Pe={style:{display:"flex","align-items":"center",width:"100%"}},Ke={style:{flex:"1"}},Te={__name:"RoleManage",setup(Ne){const U=f(!1),j=f([]),$=Z({name:""}),I=f(!1),B=f("create"),u=Z({id:null,name:"",key:"",desc:""}),M=f(!1),H=f([]),z=f(null),N=f([]),b=f(null),A=f(!1),R=f(!1),C=f([]),x=f(null),P=f([]),L=f(!1),ee=t=>{if(!t)return"";try{const e=new Date(t);if(isNaN(e.getTime()))return t;const n=e.getFullYear(),c=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${n}-${c}-${o}`}catch{return typeof t=="string"&&/^\d{4}-\d{2}-\d{2}/.test(t)?t.split(" ")[0]||t.split("T")[0]:t}},K=async()=>{U.value=!0;try{const t=await xe({page:1,size:100,name:$.name});j.value=(t.list||[]).map(e=>({...e,createdAt:ee(e.createdAt)}))}catch(t){d.error("获取角色列表失败"),console.error(t)}finally{U.value=!1}},le=()=>{K()},se=()=>{$.name="",K()},O=async(t,e)=>{if(B.value=t,I.value=!0,t==="edit"&&e)try{const n=await Ve({id:e.id});Object.assign(u,n)}catch(n){d.error("获取角色信息失败"),console.error(n)}else Object.assign(u,{id:null,name:"",key:"",desc:""})},oe=async()=>{if(!u.name||!u.key){d.warning("请填写完整信息");return}try{B.value==="create"?(await $e({name:u.name,key:u.key,desc:u.desc}),d.success("创建成功")):(await Ie({id:u.id,name:u.name,key:u.key,desc:u.desc}),d.success("更新成功")),I.value=!1,K()}catch(t){d.error("操作失败"),console.error(t)}},te=t=>{Ce.confirm("确认删除？","提示",{type:"warning"}).then(async()=>{try{await De({id:t.id}),d.success("删除成功"),K()}catch(e){d.error("删除失败"),console.error(e)}}).catch(()=>{})},ne=async t=>{b.value=t.id,M.value=!0,N.value=[];try{const e=await X({});H.value=e.list||[]}catch(e){d.error("获取权限列表失败"),console.error(e);return}try{const e=await Q({id:t.id});N.value=e.permissionIds||[],await J(),z.value&&z.value.setCheckedKeys(N.value)}catch(e){d.error("获取角色权限失败"),console.error(e)}},ae=async()=>{if(!b.value)return;const t=z.value.getCheckedKeys(),e=z.value.getHalfCheckedKeys(),n=[...t,...e];A.value=!0;try{await W({id:b.value,permissionIds:n}),d.success("权限分配成功"),M.value=!1}catch(c){d.error("权限分配失败"),console.error(c)}finally{A.value=!1}},re=t=>{const e=[],n=c=>{c.forEach(o=>{let y=!1;if(o.permission){const h=k.value.find(a=>a.code===o.permission);h&&t.includes(h.id)&&(e.push(o.id),y=!0)}if(!y&&o.path){const h=k.value.find(a=>a.path===o.path&&a.type==="menu");h&&t.includes(h.id)&&e.push(o.id)}o.children&&o.children.length>0&&n(o.children)})};return n(C.value),e},k=f([]),ie=async t=>{b.value=t.id,R.value=!0,P.value=[];try{const e=await X({}),n=c=>{const o=[];return c.forEach(y=>{o.push(y),y.children&&y.children.length>0&&o.push(...n(y.children))}),o};k.value=n(e.list||[]),console.log("加载的权限列表:",k.value)}catch(e){d.error("获取权限列表失败"),console.error(e);return}try{const e=await be({});C.value=e.list||[],console.log("加载的菜单列表:",C.value)}catch(e){d.error("获取菜单列表失败"),console.error(e);return}try{const n=(await Q({id:t.id})).permissionIds||[];console.log("角色已有权限ID:",n),P.value=re(n),console.log("转换后的菜单ID:",P.value),await J(),x.value&&x.value.setCheckedKeys(P.value)}catch(e){d.error("获取角色权限失败"),console.error(e)}},de=async()=>{var t,e;if(!b.value||!x.value){d.warning("请先选择菜单");return}try{const n=x.value.getCheckedKeys(),c=x.value.getHalfCheckedKeys();if(console.log("选中的菜单ID:",n),console.log("半选中的菜单ID:",c),console.log("所有权限列表:",k.value),console.log("菜单树:",C.value),n.length===0&&c.length===0){d.warning("请至少选择一个菜单");return}const o=[],y=h=>{h.forEach(a=>{if(n.includes(a.id)||c.includes(a.id))if(console.log(`处理菜单: ${a.title}, ID: ${a.id}, permission: ${a.permission}, path: ${a.path}`),a.permission){const v=k.value.find(m=>m.code===a.permission);v?(console.log(`找到权限: ${v.name}, ID: ${v.id}`),o.includes(v.id)||o.push(v.id)):(console.warn(`菜单 ${a.title} 的权限标识 ${a.permission} 未找到对应的权限`),console.warn("可用权限代码:",k.value.map(m=>m.code)))}else{const v=k.value.find(m=>m.path===a.path&&m.type==="menu");v?(console.log(`通过path找到权限: ${v.name}, ID: ${v.id}`),o.includes(v.id)||o.push(v.id)):(console.warn(`菜单 ${a.title} (${a.path}) 没有关联的权限，无法授权`),console.warn("可用权限path:",k.value.filter(m=>m.type==="menu").map(m=>m.path)))}a.children&&a.children.length>0&&y(a.children)})};if(y(C.value),console.log("收集到的权限ID:",o),o.length===0){d.warning("选中的菜单没有关联的权限，请检查菜单配置或联系管理员");return}L.value=!0,await W({id:b.value,permissionIds:o}),d.success("菜单分配成功"),R.value=!1}catch(n){console.error("菜单分配失败:",n),d.error(((e=(t=n.response)==null?void 0:t.data)==null?void 0:e.message)||n.message||"菜单分配失败")}finally{L.value=!1}};return fe(()=>{K()}),(t,e)=>{const n=g("el-input"),c=g("el-form-item"),o=g("el-button"),y=g("el-form"),h=g("el-card"),a=g("el-table-column"),v=g("el-table"),m=g("el-dialog"),S=g("el-icon"),E=g("el-tag"),Y=g("el-tree"),ue=me("loading");return w(),pe("div",Me,[l(h,{shadow:"never",class:"filter-card"},{default:s(()=>[l(y,{inline:!0,model:$,class:"filter-form"},{default:s(()=>[l(c,{label:"角色名称"},{default:s(()=>[l(n,{modelValue:$.name,"onUpdate:modelValue":e[0]||(e[0]=r=>$.name=r),placeholder:"请输入角色名称",clearable:"","prefix-icon":_(q),style:{width:"260px"},size:"default"},null,8,["modelValue","prefix-icon"])]),_:1}),l(c,null,{default:s(()=>[l(o,{type:"primary",icon:_(q),onClick:le,size:"default"},{default:s(()=>[...e[11]||(e[11]=[p("查询",-1)])]),_:1},8,["icon"]),l(o,{icon:_(ye),onClick:se,size:"default"},{default:s(()=>[...e[12]||(e[12]=[p("重置",-1)])]),_:1},8,["icon"])]),_:1}),l(c,{style:{"margin-left":"auto"}},{default:s(()=>[l(o,{type:"primary",icon:_(ve),onClick:e[1]||(e[1]=r=>O("create")),size:"default"},{default:s(()=>[...e[13]||(e[13]=[T("span",{style:{"margin-left":"4px"}},"新增角色",-1)])]),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),l(h,{shadow:"never",class:"table-card"},{default:s(()=>[ge((w(),V(v,{data:j.value,style:{width:"100%"}},{default:s(()=>[l(a,{prop:"id",label:"ID",width:"80"}),l(a,{prop:"name",label:"角色名称"}),l(a,{prop:"key",label:"权限字符"}),l(a,{prop:"desc",label:"描述"}),l(a,{prop:"createdAt",label:"创建时间"}),l(a,{label:"操作",width:"280",fixed:"right"},{default:s(r=>[l(o,{link:"",type:"primary",size:"small",icon:_(he),onClick:i=>O("edit",r.row)},{default:s(()=>[...e[14]||(e[14]=[p("编辑",-1)])]),_:1},8,["icon","onClick"]),l(o,{link:"",type:"success",size:"small",icon:_(ke),onClick:i=>ne(r.row)},{default:s(()=>[...e[15]||(e[15]=[p("权限",-1)])]),_:1},8,["icon","onClick"]),l(o,{link:"",type:"warning",size:"small",icon:_(_e),onClick:i=>ie(r.row)},{default:s(()=>[...e[16]||(e[16]=[p("菜单",-1)])]),_:1},8,["icon","onClick"]),l(o,{link:"",type:"danger",size:"small",icon:_(we),onClick:i=>te(r.row)},{default:s(()=>[...e[17]||(e[17]=[p("删除",-1)])]),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["data"])),[[ue,U.value]])]),_:1}),l(m,{modelValue:I.value,"onUpdate:modelValue":e[6]||(e[6]=r=>I.value=r),title:B.value==="create"?"新增角色":"编辑角色",width:"40%"},{footer:s(()=>[l(o,{onClick:e[5]||(e[5]=r=>I.value=!1)},{default:s(()=>[...e[18]||(e[18]=[p("取消",-1)])]),_:1}),l(o,{type:"primary",onClick:oe},{default:s(()=>[...e[19]||(e[19]=[p("确认",-1)])]),_:1})]),default:s(()=>[l(y,{model:u,"label-width":"80px"},{default:s(()=>[l(c,{label:"名称"},{default:s(()=>[l(n,{modelValue:u.name,"onUpdate:modelValue":e[2]||(e[2]=r=>u.name=r)},null,8,["modelValue"])]),_:1}),l(c,{label:"权限字符"},{default:s(()=>[l(n,{modelValue:u.key,"onUpdate:modelValue":e[3]||(e[3]=r=>u.key=r)},null,8,["modelValue"])]),_:1}),l(c,{label:"描述"},{default:s(()=>[l(n,{modelValue:u.desc,"onUpdate:modelValue":e[4]||(e[4]=r=>u.desc=r),type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(m,{modelValue:M.value,"onUpdate:modelValue":e[8]||(e[8]=r=>M.value=r),title:"分配权限",width:"600px","close-on-click-modal":!1},{footer:s(()=>[l(o,{onClick:e[7]||(e[7]=r=>M.value=!1)},{default:s(()=>[...e[20]||(e[20]=[p("取消",-1)])]),_:1}),l(o,{type:"primary",onClick:ae,loading:A.value},{default:s(()=>[...e[21]||(e[21]=[p("保存",-1)])]),_:1},8,["loading"])]),default:s(()=>[l(Y,{ref_key:"permissionTreeRef",ref:z,data:H.value,props:{label:"name",children:"children"},"show-checkbox":"","node-key":"id","default-checked-keys":N.value,style:{"max-height":"400px","overflow-y":"auto"}},{default:s(({node:r,data:i})=>[T("div",ze,[i.icon?(w(),V(S,{key:0,style:{"margin-right":"8px",color:"#409eff"}},{default:s(()=>[(w(),V(G(i.icon)))]),_:2},1024)):F("",!0),T("span",Re,D(i.name),1),l(E,{size:"small",type:"info",style:{"margin-left":"8px"}},{default:s(()=>[p(D(i.code),1)]),_:2},1024),l(E,{size:"small",type:i.type==="menu"?"primary":"warning",style:{"margin-left":"8px"}},{default:s(()=>[p(D(i.type==="menu"?"菜单":"按钮"),1)]),_:2},1032,["type"])])]),_:1},8,["data","default-checked-keys"])]),_:1},8,["modelValue"]),l(m,{modelValue:R.value,"onUpdate:modelValue":e[10]||(e[10]=r=>R.value=r),title:"分配菜单",width:"600px","close-on-click-modal":!1},{footer:s(()=>[l(o,{onClick:e[9]||(e[9]=r=>R.value=!1)},{default:s(()=>[...e[22]||(e[22]=[p("取消",-1)])]),_:1}),l(o,{type:"primary",onClick:de,loading:L.value},{default:s(()=>[...e[23]||(e[23]=[p("保存",-1)])]),_:1},8,["loading"])]),default:s(()=>[l(Y,{ref_key:"menuTreeRef",ref:x,data:C.value,props:{label:"title",children:"children"},"show-checkbox":"","node-key":"id","default-checked-keys":P.value,style:{"max-height":"400px","overflow-y":"auto"}},{default:s(({node:r,data:i})=>[T("div",Pe,[i.icon?(w(),V(S,{key:0,style:{"margin-right":"8px",color:"#409eff"}},{default:s(()=>[(w(),V(G(i.icon)))]),_:2},1024)):F("",!0),T("span",Ke,D(i.title),1),l(E,{size:"small",type:i.type==="M"?"info":i.type==="C"?"success":"warning",style:{"margin-left":"8px"}},{default:s(()=>[p(D(i.type==="M"?"目录":i.type==="C"?"菜单":"按钮"),1)]),_:2},1032,["type"]),i.path?(w(),V(E,{key:1,size:"small",type:"info",style:{"margin-left":"8px"}},{default:s(()=>[p(D(i.path),1)]),_:2},1024)):F("",!0)])]),_:1},8,["data","default-checked-keys"])]),_:1},8,["modelValue"])])}}},Ae=ce(Te,[["__scopeId","data-v-b6468bdd"]]);export{Ae as default};
