import{aw as V,_ as A,r as S,o as J,a as k,d as a,g as r,h as x,z as $,l as g,b as o,s as I,u as _,a1 as j,F as H,p as W,a7 as K,C as N,a9 as R,b3 as D,t as B,ao as U,af as E,y as z,m as L,b4 as F,aq as P,au as q,E as M,av as G}from"./index-DJyl22Gq.js";import{d as Q}from"./marked.esm-DajSjiQI.js";async function X(C,s,v){const d=localStorage.getItem("token"),u=await fetch("/api/chat/message",{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream",...d?{Authorization:`Bearer ${d}`}:{}},body:JSON.stringify(C)});if(!u.ok){const f=await u.json().catch(()=>({}));throw new Error(f.message||`HTTP error! status: ${u.status}`)}const h=u.body.getReader(),T=new TextDecoder("utf-8");let w="",m=null;try{for(;;){const{value:f,done:i}=await h.read();if(i)break;w+=T.decode(f,{stream:!0});const t=w.split(`
`);w=t.pop()||"";for(const n of t){const l=n.trim();if(!l){m=null;continue}if(console.log("收到行:",l.substring(0,100)),l.startsWith("event: ")){m=l.substring(7),console.log("设置事件类型:",m);continue}if(l.startsWith("data: ")){const e=l.substring(6);if(e==="[DONE]")continue;if(m==="done"){try{const c=JSON.parse(e);c.sessionId&&(console.log("会话完成，sessionId:",c.sessionId),v(c.sessionId))}catch(c){console.error("解析完成事件失败:",c,"data:",e)}m=null;continue}try{const c=JSON.parse(e);typeof c=="string"?(console.log("收到内容块:",c),s(c)):console.warn("未知的JSON格式:",c)}catch{if(e.startsWith('"')&&e.endsWith('"'))try{const b=JSON.parse(e);console.log("解析JSON转义字符串:",b),s(b)}catch{console.log("使用原始内容:",e),s(e)}else console.log("直接使用文本:",e),s(e)}m=null}}}}finally{h.releaseLock()}}function Y(C){return V({url:"/chat/clearSession",method:"post",data:C})}const Z={class:"chat-container"},ee={class:"chat-header"},se={class:"header-left"},te={class:"header-right"},ae={class:"chat-content"},ne={key:0,class:"empty-message"},oe={class:"message-avatar"},le={class:"message-content"},re=["innerHTML"],ie={class:"message-time"},ce={key:1,class:"message-item ai-message"},de={class:"message-avatar"},ue={class:"message-content"},me={class:"message-text loading-text"},fe={class:"input-container"},ge={class:"input-actions"},_e={__name:"Chat",setup(C){const s=S([]),v=S(""),d=S(!1),p=S(""),u=S(null),h=async()=>{const i=v.value.trim();if(!i||d.value)return;const t={role:"user",content:i,timestamp:Date.now()};s.value.push(t),v.value="",f(),d.value=!0;const n=s.value.length,l={role:"assistant",content:"",timestamp:Date.now()};s.value.push(l),f();try{await X({message:i,sessionId:p.value||void 0},e=>{console.log("收到数据块:",e),s.value[n]&&(s.value[n].content+=e,f())},e=>{console.log("会话完成，sessionId:",e),e&&(p.value=e)})}catch(e){console.error("发送消息失败:",e),s.value[n]&&s.value[n].content===""&&s.value.splice(n,1),s.value.length>0&&s.value[s.value.length-1].role==="user"&&s.value.pop(),e.message&&e.message.includes("timeout")?M.error("请求超时，AI响应时间较长，请稍后重试"):M.error(e.message||"发送消息失败，请稍后重试")}finally{d.value=!1,s.value[n]&&(s.value[n].timestamp=Date.now())}},T=async()=>{if(p.value)try{await G.confirm("确定要清除当前会话吗？清除后将无法恢复对话历史。","确认清除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Y({sessionId:p.value}),s.value=[],p.value="",M.success("会话已清除")}catch(i){i!=="cancel"&&M.error(i.message||"清除会话失败")}},w=i=>{try{return Q.parse(i)}catch{return i.replace(/\n/g,"<br>")}},m=i=>{const t=new Date(i),l=new Date-t;return l<6e4?"刚刚":l<36e5?`${Math.floor(l/6e4)}分钟前`:l<864e5?`${Math.floor(l/36e5)}小时前`:t.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},f=()=>{$(()=>{u.value&&(u.value.scrollTop=u.value.scrollHeight)})};return J(()=>{f()}),(i,t)=>{const n=x("el-icon"),l=x("el-button"),e=x("el-avatar"),c=x("el-input"),b=x("el-card");return g(),k("div",Z,[a(b,{shadow:"never",class:"chat-card"},{header:r(()=>[o("div",ee,[o("div",se,[a(n,{class:"chat-icon"},{default:r(()=>[a(_(P))]),_:1}),t[1]||(t[1]=o("span",{class:"chat-title"},"AI 智能对话",-1))]),o("div",te,[a(l,{type:"danger",size:"small",disabled:!p.value||d.value,onClick:T},{default:r(()=>[a(n,null,{default:r(()=>[a(_(q))]),_:1}),t[2]||(t[2]=L(" 清除会话 ",-1))]),_:1},8,["disabled"])])])]),default:r(()=>[o("div",ae,[o("div",{class:"messages-container",ref_key:"messagesContainer",ref:u},[s.value.length===0?(g(),k("div",ne,[a(n,{class:"empty-icon"},{default:r(()=>[a(_(j))]),_:1}),t[3]||(t[3]=o("p",null,"开始与 AI 对话吧！",-1))])):I("",!0),(g(!0),k(H,null,W(s.value,(y,O)=>(g(),k("div",{key:O,class:K(["message-item",y.role==="user"?"user-message":"ai-message"])},[o("div",oe,[y.role==="user"?(g(),N(e,{key:0,size:32},{default:r(()=>[a(n,null,{default:r(()=>[a(_(R))]),_:1})]),_:1})):(g(),N(e,{key:1,size:32,style:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"}},{default:r(()=>[a(n,null,{default:r(()=>[a(_(D))]),_:1})]),_:1}))]),o("div",le,[o("div",{class:"message-text",innerHTML:w(y.content)},null,8,re),o("div",ie,B(m(y.timestamp)),1)])],2))),128)),d.value?(g(),k("div",ce,[o("div",de,[a(e,{size:32,style:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"}},{default:r(()=>[a(n,null,{default:r(()=>[a(_(D))]),_:1})]),_:1})]),o("div",ue,[o("div",me,[a(n,{class:"is-loading"},{default:r(()=>[a(_(U))]),_:1}),t[4]||(t[4]=o("span",null,"AI 正在思考中...",-1))])])])):I("",!0)],512),o("div",fe,[a(c,{modelValue:v.value,"onUpdate:modelValue":t[0]||(t[0]=y=>v.value=y),type:"textarea",rows:3,placeholder:"输入您的问题...",disabled:d.value,onKeydown:[E(z(h,["ctrl"]),["enter"]),E(z(h,["meta"]),["enter"])],class:"message-input"},null,8,["modelValue","disabled","onKeydown"]),o("div",ge,[t[5]||(t[5]=o("div",{class:"input-tips"},[o("span",null,"按 Ctrl+Enter 或 Cmd+Enter 发送")],-1)),a(l,{type:"primary",loading:d.value,disabled:!v.value.trim(),onClick:h,class:"send-button"},{default:r(()=>[d.value?I("",!0):(g(),N(n,{key:0},{default:r(()=>[a(_(F))]),_:1})),L(" "+B(d.value?"发送中...":"发送"),1)]),_:1},8,["loading","disabled"])])])])]),_:1})])}}},he=A(_e,[["__scopeId","data-v-cdd6cdce"]]);export{he as default};
