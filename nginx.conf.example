# Nginx 配置示例
# 用于 blog.renhj.cc 域名的代理配置
# 
# 使用方法：
# 1. 将 /path/to/blog 替换为实际的项目路径
# 2. 将配置文件复制到 /etc/nginx/sites-available/blog.renhj.cc
# 3. 创建软链接: ln -s /etc/nginx/sites-available/blog.renhj.cc /etc/nginx/sites-enabled/
# 4. 测试配置: nginx -t
# 5. 重载配置: nginx -s reload 或 systemctl reload nginx

server {
    listen 80;
    #listen 443 ssl http2;
    server_name blog.renhj.cc;

    # SSL 证书配置（如果使用 HTTPS）
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;

    # 前端静态文件根目录
    # 注意：请将 /path/to/blog 替换为实际的项目路径
    root /opt/blog/fronted/dist;
    index index.html;

    # SEO文件：sitemap.xml 和 robots.txt
    # 这些文件需要直接通过根路径访问，不经过 /api 前缀
    # 搜索引擎会直接访问 https://blog.renhj.cc/sitemap.xml 和 https://blog.renhj.cc/robots.txt
    location = /sitemap.xml {
        proxy_pass http://127.0.0.1:8000/sitemap.xml;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /robots.txt {
        proxy_pass http://127.0.0.1:8000/robots.txt;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API 请求代理到后端（必须在其他 location 之前，避免被其他规则匹配）
    # 前端请求: /api/article/getList
    # Nginx 转发到: http://127.0.0.1:8000/article/getList (去掉 /api 前缀)
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 去掉 /api 前缀
        rewrite ^/api/(.*)$ /$1 break;
    }

    # 静态资源（上传的文件）
    # 注意：如果使用阿里云OSS存储，后端返回的URL是OSS的完整URL（如 https://bucket.oss-cn-hangzhou.aliyuncs.com/...）
    # 这种情况下不需要配置 /uploads location，文件会直接从OSS访问
    # 如果后端返回的是相对路径（如 /uploads/images/xxx.jpg），则需要取消下面的注释
    # location /uploads {
    #     alias /opt/blog/backend/public/uploads;
    #     expires 30d;
    #     add_header Cache-Control "public, immutable";
    # }

    # 前端静态资源文件（assets 目录下的 JS、CSS 等）
    # 这些文件需要直接返回，不走 Vue Router
    # 例如: /assets/index-p_smhSHX.js
    # 使用精确匹配确保优先级高于 location /
    location ^~ /assets {
        try_files $uri =404;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 其他静态资源（logo、vite.svg 等根目录下的文件）
    # 使用正则匹配，优先级高于 location /
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        try_files $uri =404;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 前端路由（Vue Router Hash 模式）
    # Hash 模式下，所有非静态资源的请求都返回 index.html
    # Hash 路由由前端处理，不需要服务器端配置
    location / {
        try_files $uri $uri/ /index.html;
    }
}
